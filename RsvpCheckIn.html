<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="styles/style.css"/>
    <script type="text/javascript" src="node_modules/qrcode-generator/qrcode.js"></script>
    <script type="text/javascript" src="node_modules/qr_packed.js"></script>
    <title>RSVP checkin</title>
  </head>
  <body>
    <h1>Check In Form New</h1>
    <form class="checkInForm">
      <h2>Bohemia January Hiring Event</h2>
      <br />First Name: <input id="firstInput" type="text"/>
      <br />
      <br/>Last Name: <input id="lastInput" type="text"/>
      <br />
      <br />Confirmation: <input id="confirmationInput" type="text"/></br>
      <br/>
      <!-- <input type="file" accept="image/*;capture=camera">
      <input type="file" accept="image/*" capture="user"> -->
      code: <input type=password size=16 class=qrcode-text><label class=qrcode-text-btn><input type=file accept="image/*" capture=environment onchange="openQRCamera(this);" style="width: 500px, display: block;"></label>
      </div>
      <br/>
      <br/>
      <br/>
    <button style="margin-left: 35%;"class="checkIn" type="submit">check in</button>
    </form>
    <div class="ticketResponseDiv" style="display: none">

    </div>
    <script>
//     navigator.getUserMedia = navigator.getUserMedia ||
//                          navigator.webkitGetUserMedia ||
//                          navigator.mozGetUserMedia;
//
//     if (navigator.getUserMedia) {
//      navigator.getUserMedia({ audio: true, video: { width: 1280, height: 720 } },
//       function(stream) {
//         debugger
//          var picture = document.querySelector('video');
//          picture.srcObject = stream;
//          picture.onloadedmetadata = function(e) {
//            picture.play();
//          };
//       },
//       function(err) {
//          console.log("The following error occurred: " + err.name);
//       }
//    );
// } else {
//    console.log("getUserMedia not supported");
// }
    let checkInForm = document.getElementsByClassName("checkInForm")[0]
    let checkIn = document.getElementsByClassName("checkIn")[0]
    let code = document.getElementsByClassName("qrcode-text")[0]
    let ticketResponse = document.getElementsByClassName("ticketResponseDiv")[0]
    document.addEventListener('DOMContentLoaded', function(){
      let firstInput = document.getElementById("firstInput")
      let lastInput = document.getElementById("lastInput")
      let confirmationNum = document.getElementById("confirmationInput")

      checkInForm.addEventListener("submit", submitCheckIn)
      console.log(code.value)
    })

    function openQRCamera(node) {
      console.log(node.value)
      var reader = new FileReader();
      reader.onload = function() {
        debugger
        node.value = "";
        qrcode.callback = function(res) {
          debugger
          if(res instanceof Error) {
            alert("No QR code found. Please make sure the QR code is within the camera's frame and try again.");
          } else {
            //node value is being recognized
            debugger
            node.parentNode.previousElementSibling.value = res;
          }
        };
        qrcode.decode(reader.result);
      };
      reader.readAsDataURL(node.files[0]);
      debugger
    }

    function showQRIntro() {
      debugger
      return confirm("Use your camera to take a picture of a QR code.");
    }

    function submitCheckIn(e){
      console.log(code.value)
      e.preventDefault()
      debugger
      fetch("http://localhost:3000/company_lead_rsvp_tickets", {
            headers: {"Content-Type": "application/json",
            "Accept":"application/json"},
            method: "POST",
            body: JSON.stringify({
              otp_secret_key: code.value,
              first_name: firstInput.value,
              last_name: lastInput.value,
            })
          })
          .then(res => res.json())
          .then(json => findTicket(json))
    }

    function findTicket(data){
      if (!data.company_lead_rsvp_ticket){
        ticketResponse.innerText = "RSVP not found"
        ticketResponse.style.display = "unset"
        ticketResponse.style.border = "solid 1px black"
        ticketResponse.style.position = "fixed"
        ticketResponse.style.left = "30%"
        ticketResponse.style.top = "80%"
      } else if (data.company_lead_rsvp_ticket){
      fetch(`http://localhost:3000/company_lead_rsvp_tickets/${data.company_lead_rsvp_ticket.id}`, {
            headers: {"Content-Type": "application/json",
            "Accept":"application/json"},
            method: "PATCH",
            body: JSON.stringify({
              scanned: true
            })
          })
          .then(res => res.json())
          .then(json => renderTicketResponse(json))
        }
    }

    function renderTicketResponse(data){
      debugger
        ticketResponse.innerText = "Checkin Successful!"
        ticketResponse.style.display = "unset"
        ticketResponse.style.border = "solid 1px black"
        ticketResponse.style.position = "fixed"
        ticketResponse.style.left = "30%"
        ticketResponse.style.top = "80%"
      }
    </script>
    </body>
</html>
